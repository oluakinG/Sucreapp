<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sucre Hub Command - Scanner Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: #007bff; outline: none; box-shadow: 0 0 5px rgba(0,123,255,0.5); }
        .controls { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; background: #eee; padding: 15px; border-radius: 8px; margin: 20px 0; align-items: end; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #2c3e50; color: white; }
        .btn-primary { background: #007bff; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; font-size: 18px; margin-top: 10px; }
        .btn-pdf { background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; }
        .status-pill { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ðŸ“¦ Sucre Logistics Hub</h2>
        <div class="form-group">
            <input type="text" id="trackingInput" placeholder="Scan Barcode Now..." autofocus>
            <input type="text" id="phoneInput" placeholder="Customer Phone (+1...)">
            <select id="agentSelect">
                <option>Agent Alpha</option>
                <option>Agent Bravo</option>
            </select>
            <textarea id="contentsInput" placeholder="Package Contents..."></textarea>
            <button class="btn-primary" id="logBtn" onclick="logAndNotify()">Log & Notify</button>
        </div>

        <div class="controls">
            <div>
                <label style="font-size:11px;">Filter Day</label>
                <input type="date" id="dateToggle" onchange="fetchLogsByDate()">
            </div>
            <div>
                <label style="font-size:11px;">Global Tracking Search</label>
                <input type="text" id="searchInput" placeholder="Type ID and hit Enter..." onkeypress="if(event.key==='Enter') searchLogs()">
            </div>
            <button class="btn-pdf" onclick="downloadPDF()">Export PDF</button>
        </div>

        <table id="logsTable">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Tracking ID</th>
                    <th>Contents</th>
                    <th>Agent</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // REPLACE THIS URL with your "New Deployment" URL from Google Apps Script
        const APP_URL = "https://script.google.com/macros/s/AKfycbwrntvyPg_BF9h-od-yYHIqHqVv1kzwwEeBDFe3uafVj9uVdL6Y63VZB_wnLJw3rs4l/exec";
        
        const successSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');

        // Handle scanner "Enter" key
        document.getElementById('trackingInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                logAndNotify();
            }
        });

        async function logAndNotify() {
            const trk = document.getElementById('trackingInput');
            const phone = document.getElementById('phoneInput');
            const agent = document.getElementById('agentSelect');
            const cont = document.getElementById('contentsInput');
            const btn = document.getElementById('logBtn');

            if(!trk.value) {
                alert("Please scan or enter a Tracking ID");
                return;
            }

            // Prepare data as URL parameters to avoid CORS JSON issues
            const params = new URLSearchParams();
            params.append('trackingId', trk.value);
            params.append('phone', phone.value);
            params.append('agent', agent.value);
            params.append('contents', cont.value);

            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                // Use no-cors mode for Google Scripts
                await fetch(APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });

                // Since no-cors doesn't return a readable response, we trigger success here
                successSound.play();
                trk.value = "";
                phone.value = "";
                cont.value = "";
                trk.focus();
                
                // Give the sheet a second to process before refreshing table
                setTimeout(fetchLogsByDate, 1500);

            } catch (e) {
                console.error("Submission Error:", e);
                alert("Error saving. Check your internet or Google Script deployment.");
            } finally {
                btn.innerText = "Log & Notify";
                btn.disabled = false;
            }
        }

        async function fetchLogsByDate() {
            const date = document.getElementById('dateToggle').value;
            try {
                const response = await fetch(`${APP_URL}?date=${date}`);
                const data = await response.json();
                updateTable(data);
            } catch (e) {
                console.log("Empty or no logs for this date.");
            }
        }

        async function searchLogs() {
            const query = document.getElementById('searchInput').value;
            const response = await fetch(`${APP_URL}?search=${query}`);
            const data = await response.json();
            updateTable(data);
            document.getElementById('dateToggle').value = "";
        }

        function updateTable(data) {
            const tbody = document.querySelector("#logsTable tbody");
            if (!data || data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4'>No logs found</td></tr>";
                return;
            }
            tbody.innerHTML = data.reverse().map(row => `
                <tr>
                    <td><span class="status-pill">LOGGED</span></td>
                    <td>${row[1] || ''}</td>
                    <td>${row[4] || ''}</td>
                    <td>${row[3] || ''}</td>
                </tr>
            `).join('');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = document.getElementById('dateToggle').value || "Report";
            doc.text(`Sucre Logistics Daily Report: ${date}`, 14, 15);
            doc.autoTable({ html: '#logsTable', startY: 25, theme: 'grid' });
            doc.save(`Sucre_Report_${date}.pdf`);
        }

        // Initialize table
        document.getElementById('dateToggle').valueAsDate = new Date();
        fetchLogsByDate();
    </script>
</body>
</html>
